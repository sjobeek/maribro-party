<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <meta name="title" content="Score Race" />
    <meta name="description" content="Mash south/east to reach 10 points first." />
    <meta name="author" content="maribro-party" />
    <meta name="maxDurationSec" content="45" />
    <meta name="creatorAvatarId" content="knight-red" />

    <title>Score Race</title>
    <script src="/maribro-sdk.js"></script>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        overflow: hidden;
        background: radial-gradient(1100px 700px at 20% 20%, #1d2a62 0%, #070a14 55%);
        color: rgba(255, 255, 255, 0.92);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      }
      #c {
        display: block;
        width: 100%;
        height: 100%;
      }
      .hud {
        position: fixed;
        top: 14px;
        left: 14px;
        display: grid;
        gap: 8px;
        padding: 12px 14px;
        border-radius: 14px;
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.14);
        backdrop-filter: blur(10px);
      }
      .muted {
        color: rgba(255, 255, 255, 0.7);
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <canvas id="c"></canvas>
    <div class="hud">
      <div style="font-weight: 900">Score Race</div>
      <div class="muted">South = +1, East = +2. First to 10 wins.</div>
      <div class="muted">Mock keys: slot0 (Space/Shift), slot1 (Enter//), slot2 (N/M), slot3 (R/Y).</div>
    </div>

    <script>
      const canvas = document.getElementById("c");
      const g = canvas.getContext("2d");
      const world = { players: [], scores: [0, 0, 0, 0] };

      function resize() {
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        canvas.width = Math.floor(window.innerWidth * dpr);
        canvas.height = Math.floor(window.innerHeight * dpr);
        g.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      window.addEventListener("resize", resize);
      resize();

      function draw() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        g.clearRect(0, 0, w, h);

        const t = Math.ceil(Maribro.getTimeRemainingMs() / 1000);
        g.fillStyle = "rgba(255,255,255,0.8)";
        g.font = "800 16px ui-sans-serif, system-ui";
        g.textAlign = "right";
        g.fillText(`${t}s`, w - 18, 30);

        const barW = Math.min(800, w - 60);
        const x0 = (w - barW) / 2;
        const y0 = h * 0.35;
        const rowH = 70;

        for (const p of world.players) {
          const s = world.scores[p.slot] || 0;
          g.fillStyle = "rgba(255,255,255,0.10)";
          g.fillRect(x0, y0 + p.slot * rowH, barW, 42);

          g.fillStyle = p.color;
          g.fillRect(x0, y0 + p.slot * rowH, (barW * Math.min(10, s)) / 10, 42);

          g.fillStyle = "rgba(255,255,255,0.95)";
          g.font = "900 16px ui-sans-serif, system-ui";
          g.textAlign = "left";
          g.fillText(`${p.name} â€” ${s}`, x0, y0 + p.slot * rowH - 10);
        }
      }

      function step() {
        for (const p of world.players) {
          const input = Maribro.getInput(p.slot);
          const south = !!input.buttons.south;
          const east = !!input.buttons.east;
          if (south && !p._southWasDown) world.scores[p.slot] = Math.min(10, world.scores[p.slot] + 1);
          if (east && !p._eastWasDown) world.scores[p.slot] = Math.min(10, world.scores[p.slot] + 2);
          p._southWasDown = south;
          p._eastWasDown = east;
        }

        const winner = world.scores.findIndex((s) => s >= 10);
        if (winner >= 0) {
          Maribro.endGame(world.scores);
          return;
        }
        draw();
        requestAnimationFrame(step);
      }

      Maribro.onReady((ctx) => {
        const players = ctx.playersBySlot || [];
        world.players = players.map((p, i) => ({
          slot: p.slot ?? i,
          name: p.name || `P${(p.slot ?? i) + 1}`,
          color: p.color || "#888",
          _southWasDown: false,
          _eastWasDown: false,
        }));
        requestAnimationFrame(step);
      });
    </script>
  </body>
</html>

